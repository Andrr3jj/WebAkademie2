"use strict";(self["webpackChunkheligonkova_akademia"]=self["webpackChunkheligonkova_akademia"]||[]).push([[9148],{9148:function(t,e,i){i.r(e),i.d(e,{default:function(){return w}});var a=i(3396),s=i(7139),r=i(9242);const d={class:"formular"},o={class:"pridanie"},n={class:"boxik",style:{width:"100%"}},l={class:"ziak"},u=["value"],c=["value"],h=["aria-busy"],y=["aria-busy"],m={key:0,class:"text small",style:{color:"#c0392b"}},p={key:1,class:"text small",style:{color:"#2e7d32"}};function f(t,e,i,f,S,g){return(0,a.wg)(),(0,a.iD)("div",d,[(0,a._)("h5",null,(0,s.zw)(g.headline),1),e[6]||(e[6]=(0,a._)("p",{class:"text"},"Vyber deň a čas hodiny.",-1)),(0,a._)("div",o,[(0,a._)("div",n,[(0,a._)("div",l,[(0,a.wy)((0,a._)("select",{"onUpdate:modelValue":e[0]||(e[0]=t=>S.selectedEditDay=t)},[e[4]||(e[4]=(0,a._)("option",{value:"",disabled:""},"Vyber deň",-1)),((0,a.wg)(!0),(0,a.iD)(a.HY,null,(0,a.Ko)(g.dniPoPi,(t=>((0,a.wg)(),(0,a.iD)("option",{key:t,value:t},(0,s.zw)(t),9,u)))),128))],512),[[r.bM,S.selectedEditDay]]),(0,a.wy)((0,a._)("select",{"onUpdate:modelValue":e[1]||(e[1]=t=>S.selectedEditTime=t)},[e[5]||(e[5]=(0,a._)("option",{value:"",disabled:""},"Vyber čas",-1)),((0,a.wg)(!0),(0,a.iD)(a.HY,null,(0,a.Ko)(g.casoveMoznostiEdit,(t=>((0,a.wg)(),(0,a.iD)("option",{key:t,value:t},(0,s.zw)(t),9,c)))),128))],512),[[r.bM,S.selectedEditTime]])])])]),(0,a._)("div",{class:"button Adumu",onClick:e[2]||(e[2]=(...t)=>g.ulozitEdit&&g.ulozitEdit(...t)),"aria-busy":S.loading},(0,s.zw)(S.loading?"Ukladám...":"Uložiť zmeny"),9,h),(0,a._)("div",{class:"button Adumu danger",onClick:e[3]||(e[3]=(...t)=>g.vymazatEdit&&g.vymazatEdit(...t)),"aria-busy":S.loading,style:{"margin-top":"1em"}},(0,s.zw)(S.loading?"Mažem...":"Vymazať"),9,y),S.error?((0,a.wg)(),(0,a.iD)("p",m,(0,s.zw)(S.error),1)):(0,a.kq)("",!0),S.message?((0,a.wg)(),(0,a.iD)("p",p,(0,s.zw)(S.message),1)):(0,a.kq)("",!0)])}i(560),i(8858),i(1318),i(3228);var S={name:"UpravaHodiny",emits:["updated","deleted"],props:{calendarId:{type:[String,Number],required:!0},dayName:{type:String,default:""},hour:{type:String,default:""},formOfStudy:{type:String,default:""},studentId:{type:[String,Number],default:null},duoStudentId:{type:[String,Number],default:null}},data(){return{loading:!1,message:"",error:"",dostupnost:[],obsadene:{},selectedEditDay:"",selectedEditTime:"",existujucaForma:"solo",slotKrokMin:15,existujuciStudenti:[]}},computed:{apiBase(){return(this.$store?.state?.api||"").replace(/\/+$/,"")+"/edupage/"},teacherId(){const t=[59,54,607,945,53],e=Number(this.$store?.state?.user?.id||0);return t.includes(e)?e:null},dniPoPi(){const t=["Pondelok","Utorok","Streda","Štvrtok","Piatok"],e=Array.from(new Set(this.dostupnost.map((t=>t.den)))),i=t.filter((t=>e.includes(t)));return i.length?i:t},casoveMoznostiEdit(){const t=this.selectedEditDay;if(!t)return[];const e=this.dostupnost.filter((e=>e.den===t));if(!e.length)return[];const i="duo"===this.existujucaForma?45:30,a=new Set;for(const o of e)for(const t of this.genSlotsFit(o.od,o.do,this.slotKrokMin,i))a.add(t);const s=Array.from(a).sort(),r=this.obsadene[t]||[],d=[];for(const o of r){if(String(o.id)===String(this.calendarId))continue;const t=this.toMin(o.time),e="duo"===o.formOfStudy?45:30;d.push([t,t+e])}return s.filter((t=>{const e=this.toMin(t),a=e+i;return!d.some((([t,i])=>e<i&&t<a))}))},headline(){return"Upraviť hodinu"}},methods:{dayToInt(t){const e={Pondelok:0,Utorok:1,Streda:2,"Štvrtok":3,Piatok:4,Sobota:5,"Nedeľa":6};return"number"===typeof t?t:e[t]??t},intToDay(t){const e=["Pondelok","Utorok","Streda","Štvrtok","Piatok","Sobota","Nedeľa"],i=Number(t);return Number.isFinite(i)?e[i]??String(t):String(t)},normalizeHour(t){const e=String(t??"");if(/^\d{1,4}$/.test(e)){const t=parseInt(e,10),i=Math.floor(t/100),a=t%100;return String(i).padStart(2,"0")+":"+String(a).padStart(2,"0")}return/^\d{2}:\d{2}$/.test(e),e},hourToIntHHMM(t){const[e,i]=String(t||"00:00").split(":").map((t=>parseInt(t,10)||0));return String(e).padStart(2,"0")+String(i).padStart(2,"0")},toMin(t){const[e,i]=String(t||"00:00").split(":").map((t=>parseInt(t,10)));return 60*(e||0)+(i||0)},toHHMM(t){const e=Math.floor(t/60),i=t%60;return String(e).padStart(2,"0")+":"+String(i).padStart(2,"0")},ceilToStep(t,e){return Math.ceil(t/e)*e},genSlotsFit(t,e,i,a){let s=this.toMin(t);const r=this.toMin(e);s=this.ceilToStep(s,i);const d=[];for(let o=s;o+a<=r;o+=i)d.push(this.toHHMM(o));return d},async nacitajDostupnost(){if(!this.teacherId)return;const t=this.apiBase+"loadCalendarCustom.php?teacher_id="+this.teacherId;try{const e=await fetch(t,{credentials:"include"}),i=await e.text();let a;try{a=JSON.parse(i)}catch{a=null}const s=a?.data&&Array.isArray(a.data)?a.data:[];this.dostupnost=s.map((t=>{let e=t.data||"{}";if("string"===typeof e)try{e=JSON.parse(e)}catch{e={}}return{den:e.den||"",od:e.od||"",do:e.do||""}})).filter((t=>t.den&&t.od&&t.do))}catch{this.dostupnost=[]}},async nacitajObsadene(){if(this.teacherId)try{const t=await fetch(this.apiBase+"loadCalendar.php?teacher_id="+this.teacherId,{credentials:"include"}),e=await t.text();let i;try{i=JSON.parse(e)}catch{i=null}const a=i?.data&&Array.isArray(i.data)?i.data:[],s={};for(const r of a){const t=this.intToDay(r.availability_day??r.day??r.den??""),e=this.normalizeHour(r.availability_hour||r.hour||r.cas||""),i=Number(r.id||r.ID||0)||null,a="duo"===(r.formOfStudy||"").toLowerCase()?"duo":"solo";t&&e&&i&&(s[t]||(s[t]=[]),s[t].push({id:i,time:e,formOfStudy:a}))}this.obsadene=s}catch{this.obsadene={}}},async nacitajDetailHodiny(t){try{const e=this.apiBase+"loadCalendar.php?id="+encodeURIComponent(t),i=await fetch(e,{credentials:"include"}),a=await i.text();let s;try{s=JSON.parse(a)}catch{s=null}const r=Array.isArray(s?.data)?s.data:Array.isArray(s)?s:[],d=r[0]||null;if(!d)return;const o=d.availability_day??d.day??d.den??"",n=d.availability_hour??d.hour??d.cas??"",l="duo"===(d.formOfStudy||"").toLowerCase()?"duo":"solo";let u=[],c=d.student??d.students??"";if("string"===typeof c&&c.trim())try{c=JSON.parse(c)}catch{c=[]}Array.isArray(c)&&(u=c.map((t=>String(t?.student_id??t)))),this.existujuciStudenti=u,this.existujucaForma=l,this.selectedEditDay=this.intToDay(o),this.selectedEditTime=this.normalizeHour(n)}catch{}},async overKolizie(t,e,i=null,a=null){await this.nacitajObsadene();const s=this.obsadene[t]||[],r=this.toMin(this.normalizeHour(e)),d=null!=a?a:"duo"===this.existujucaForma,o=d?45:30,n=r+o;for(const l of s){if(i&&String(l.id)===String(i))continue;const t=this.toMin(l.time),e="duo"===l.formOfStudy?45:30,a=t+e;if(r<a&&t<n)return`Kolízia: ${l.time} (${l.formOfStudy})`}return null},async callEditCalendarUpdate(t){const e=new URLSearchParams;e.append("id",String(t.id)),t.formOfStudy&&e.append("formOfStudy",t.formOfStudy),null!=t.availability_day&&e.append("availability_day",String(t.availability_day)),t.availability_hour&&e.append("availability_hour",t.availability_hour),Array.isArray(t.student)&&e.append("student",JSON.stringify(t.student));const i=await fetch(this.apiBase+"editCalendar.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:e,credentials:"include"}),a=await i.text();let s;try{s=JSON.parse(a)}catch{s=null}const r=String(s&&s.status||a).toLowerCase(),d=i.ok&&(!0===s||!0===s?.ok||!0===s?.success||r.includes("succes"));if(!d)throw new Error(s?.message||s?.error||"Uloženie zlyhalo.");return!0},async callEditCalendarDelete(t){const e=new URLSearchParams;e.append("id",String(t)),e.append("delete","true");const i=await fetch(this.apiBase+"editCalendar.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:e,credentials:"include"}),a=await i.text();let s;try{s=JSON.parse(a)}catch{s=null}const r=String(s&&s.status||a).toLowerCase(),d=i.ok&&(!0===s||!0===s?.ok||!0===s?.success||r.includes("succes"));if(!d)throw new Error(s?.message||s?.error||"Mazanie zlyhalo.");return!0},nastavDefaultCas(){const t=this.casoveMoznostiEdit;if(t.length){if(!this.selectedEditTime||!t.includes(this.selectedEditTime))if(this.selectedEditTime){const e=this.toMin(this.selectedEditTime);let i=t[0],a=Math.abs(this.toMin(i)-e);for(const s of t){const t=Math.abs(this.toMin(s)-e);t<a&&(i=s,a=t)}this.selectedEditTime=i}else this.selectedEditTime=t[0]}else this.selectedEditTime=""},async ulozitEdit(){if(this.error="",this.message="",!this.calendarId)return void(this.error="Chýba ID hodiny.");if(!this.selectedEditDay)return void(this.error="Vyber deň.");if(!this.selectedEditTime)return void(this.error="Vyber čas.");const t=await this.overKolizie(this.selectedEditDay,this.selectedEditTime,this.calendarId,"duo"===this.existujucaForma);if(t)this.error=t;else{this.loading=!0;try{await this.callEditCalendarUpdate({id:this.calendarId,formOfStudy:this.existujucaForma,availability_day:this.dayToInt(this.selectedEditDay),availability_hour:this.hourToIntHHMM(this.selectedEditTime),student:this.existujuciStudenti}),await this.nacitajObsadene(),this.message="Hodina bola upravená.",this.$emit("updated",{id:this.calendarId,day:this.selectedEditDay,time:this.selectedEditTime})}catch(e){this.error=e?.message||"Uloženie zlyhalo."}finally{this.loading=!1}}},async vymazatEdit(){if(this.error="",this.message="",this.calendarId){this.loading=!0;try{await this.callEditCalendarDelete(this.calendarId),this.message="Hodina bola vymazaná.",this.$emit("deleted",{id:this.calendarId})}catch(t){this.error=t?.message||"Mazanie zlyhalo."}finally{this.loading=!1}}else this.error="Chýba ID hodiny."}},async mounted(){await Promise.all([this.nacitajDostupnost(),this.nacitajObsadene()]),this.formOfStudy&&(this.existujucaForma="duo"===this.formOfStudy.toLowerCase()?"duo":"solo"),this.dayName&&(this.selectedEditDay=this.dayName),this.hour&&(this.selectedEditTime=this.normalizeHour(this.hour));const t=[];null!=this.studentId&&""!==String(this.studentId).trim()&&t.push(String(this.studentId)),"duo"===this.existujucaForma&&null!=this.duoStudentId&&""!==String(this.duoStudentId).trim()&&t.push(String(this.duoStudentId)),t.length&&(this.existujuciStudenti=t),this.existujuciStudenti.length||await this.nacitajDetailHodiny(this.calendarId),this.selectedEditDay&&this.selectedEditTime||await this.nacitajDetailHodiny(this.calendarId),this.nastavDefaultCas()}},g=i(89);const b=(0,g.Z)(S,[["render",f],["__scopeId","data-v-7d149b07"]]);var w=b}}]);