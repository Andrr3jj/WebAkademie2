"use strict";(self["webpackChunkheligonkova_akademia"]=self["webpackChunkheligonkova_akademia"]||[]).push([[3886],{4015:function(e,t,n){n.d(t,{Z:function(){return u}});var s=n(3396),o=n(9242);const a={class:"modal-content base-modal"},i={class:"modal-scroll"};function r(e,t,n,r,l,d){const c=(0,s.up)("TheMenu");return(0,s.wg)(),(0,s.iD)("div",{class:"overlay",onClick:t[2]||(t[2]=(0,o.iM)((t=>e.$emit("close")),["self"]))},[(0,s._)("div",{class:"modal-overlay",onClick:t[1]||(t[1]=(0,o.iM)((t=>e.$emit("close")),["self"]))},[(0,s._)("div",a,[(0,s._)("div",i,[((0,s.wg)(),(0,s.j4)((0,s.LL)(n.contentComponent),(0,s.dG)(n.contentProps,{onClose:t[0]||(t[0]=t=>e.$emit("close"))}),null,16))])])]),(0,s.Wm)(c,{class:"fake-menu",style:{margin:"0 1em",opacity:"0","z-index":"-1","pointer-events":"none"}})])}var l=n(3239),d={components:{TheMenu:l.Z},props:{contentComponent:{type:[Object,Function,String],required:!0},contentProps:{type:Object,default:()=>({})}},mounted(){document.body.style.overflow="hidden",window.scrollTo({top:0})},beforeUnmount(){document.body.style.overflow=""}},c=n(89);const h=(0,c.Z)(d,[["render",r],["__scopeId","data-v-75c8706c"]]);var u=h},3886:function(e,t,n){n.r(t),n.d(t,{default:function(){return _}});var s=n(3396),o=n(9242),a=n(7139),i=n(1682);const r=["id"],l={class:"scroll"},d=["aria-busy"],c={key:0,class:"text small",style:{color:"#c0392b"}},h={key:1,class:"text small",style:{color:"#2e7d32"}},u=["disabled"],p={key:2,class:"ctx-err"};function y(e,t,n,y,m,g){const w=(0,s.up)("KalendarDatumHeader"),D=(0,s.up)("EdupageInfo"),f=(0,s.up)("kalendar-flow"),S=(0,s.up)("ModalSkeleton");return(0,s.wg)(),(0,s.iD)(s.HY,null,[(0,s._)("section",{id:e.$route.name,onClick:t[6]||(t[6]=(...e)=>g.closeContextMenu&&g.closeContextMenu(...e)),onContextmenu:t[7]||(t[7]=(0,o.iM)((e=>g.onSectionContext(e)),["prevent"])),tabindex:"0"},[(0,s._)("div",l,[t[0]||((0,s.qZ)(-1,!0),(t[0]=(0,s._)("h1",null,[t[8]||(t[8]=(0,s.Uk)("Rozvrh hodín"))])).cacheIndex=0,(0,s.qZ)(1),t[0]),(0,s.Wm)(w,{showFilter:m.showFilter,showDays:!0,allowedDaysFull:m.povoleneDni,allowedTimesByDay:m.povoleneCasyPodlaDna,onShowModal:g.openModal,onDayChanged:g.onDayChanged,onDateChanged:g.onDateChanged},null,8,["showFilter","allowedDaysFull","allowedTimesByDay","onShowModal","onDayChanged","onDateChanged"]),m.headerReady&&!m.showFilter?((0,s.wg)(),(0,s.j4)(D,{key:0,empty:0===m.studentsWithoutLessons,unplannedCount:m.studentsWithoutLessons,hasCalendar:g.hasCalendar,onOpenModal:g.openModal},null,8,["empty","unplannedCount","hasCalendar","onOpenModal"])):(0,s.kq)("",!0),((0,s.wg)(),(0,s.j4)(s.Ob,null,[m.flowReady&&m.showFilter?((0,s.wg)(),(0,s.j4)(f,{ref:"flow",key:m.currentDay+":"+g.selectedDateDMY,predvolenyDen:m.currentDay,selectedDate:g.selectedDateDMY,onShowModal:g.openModal,onOpenSummary:g.openSummaryModal,onOpenAddZapis:g.openAddCiselnyZapis,onOpenContext:g.openContextMenu},null,8,["predvolenyDen","selectedDate","onShowModal","onOpenSummary","onOpenAddZapis","onOpenContext"])):(0,s.kq)("",!0)],1024))]),(0,s._)("img",{class:"set",onClick:t[1]||(t[1]=t=>g.openModal({component:e.CasyUcenia})),src:i,alt:""}),(0,s._)("button",{class:"button Adumu","aria-busy":m.createBusy,onClick:t[2]||(t[2]=(...e)=>g.createLessonsNextWeek&&g.createLessonsNextWeek(...e))},(0,a.zw)(m.createBusy?"Vytváram…":"Vytvoriť lekcie"),9,d),m.createErr?((0,s.wg)(),(0,s.iD)("p",c,(0,a.zw)(m.createErr),1)):(0,s.kq)("",!0),m.createMsg?((0,s.wg)(),(0,s.iD)("p",h,(0,a.zw)(m.createMsg),1)):(0,s.kq)("",!0),((0,s.wg)(),(0,s.j4)(s.lR,{to:"body"},[(0,s.Wm)(o.uT,{name:"ctx"},{default:(0,s.w5)((()=>[m.contextMenu.visible?((0,s.wg)(),(0,s.iD)("div",{key:0,ref:"ctxMenu",class:"context-menu",style:(0,a.j5)({transform:`translate3d(${m.contextMenu.x}px, ${m.contextMenu.y}px, 0)`}),onClick:t[5]||(t[5]=(0,o.iM)((()=>{}),["stop"]))},["section"===m.contextMenu.mode?((0,s.wg)(),(0,s.iD)("button",{key:0,class:"ctx-item",onClick:t[3]||(t[3]=(...e)=>g.onAddStudent&&g.onAddStudent(...e))}," Pridať žiaka ")):((0,s.wg)(),(0,s.iD)("button",{key:1,class:"ctx-item danger",disabled:m.contextMenu.busy||!m.contextMenu.target?.id,onClick:t[4]||(t[4]=(...e)=>g.deleteSelected&&g.deleteSelected(...e))},(0,a.zw)(m.contextMenu.busy?"Mažem…":"Vymazať hodinu"),9,u)),m.contextMenu.error?((0,s.wg)(),(0,s.iD)("p",p,(0,a.zw)(m.contextMenu.error),1)):(0,s.kq)("",!0)],4)):(0,s.kq)("",!0)])),_:1})]))],40,r),m.modalOpen?((0,s.wg)(),(0,s.j4)(S,{key:0,"content-component":m.modalComponent,"content-props":m.modalProps,onClose:g.handleModalClose},null,8,["content-component","content-props","onClose"])):(0,s.kq)("",!0)],64)}n(560),n(8858),n(1318),n(3228);var m=n(4015);const g=(0,s.RC)((()=>n.e(1854).then(n.bind(n,1854)))),w=(0,s.RC)((()=>n.e(6105).then(n.bind(n,6105)))),D=(0,s.RC)((()=>n.e(5377).then(n.bind(n,5377)))),f=(0,s.RC)((()=>n.e(3736).then(n.bind(n,3736)))),S=(0,s.RC)((()=>n.e(5083).then(n.bind(n,5083)))),v=(0,s.RC)((()=>n.e(4368).then(n.bind(n,4368)))),M=(0,s.RC)((()=>n.e(8870).then(n.bind(n,8870)))),C=(0,s.RC)((()=>n.e(9148).then(n.bind(n,9148)))),x="edp.selectedDateISO",k="edp.currentDay",I="edp.cache.availability.v1",b="edp.cache.hasHours.v1",O="edp.cache.unplanned.v1";var R={components:{KalendarDatumHeader:g,KalendarFlow:w,ModalSkeleton:m.Z,CasyUcenia:D,EdupageInfo:f,PridanieZiakaDoRozvrhu:S,ZhrnutieLekcie:v,PridatCiselnyZapis:M,UpravaHodiny:C},data(){const e=localStorage.getItem(x)||"",t=localStorage.getItem(k)||"";let n=null;try{n=JSON.parse(localStorage.getItem(I)||"null")}catch{n=null}return{modalOpen:!1,modalComponent:D,modalProps:{},showFilter:!(!n||!n.povoleneDni?.length),flowReady:!0,headerReady:!0,studentsWithoutLessons:Number(localStorage.getItem(O)||0),contextMenu:{visible:!1,x:0,y:0,mode:"section",target:null,busy:!1,error:""},dostupnost:n?.dostupnost||[],povoleneDni:n?.povoleneDni||[],povoleneCasyPodlaDna:n?.povoleneCasyPodlaDna||{},hasAnyHours:JSON.parse(localStorage.getItem(b)||"false"),currentDay:t,selectedDateISO:e,createBusy:!1,createMsg:"",createErr:"",acLoads:{},flowReloadScheduled:!1,slotCache:new Map}},provide(){const e=this;return{getEdupageAvailability:()=>e.dostupnost,getAllowedDaysFull:()=>e.povoleneDni,getAllowedTimesByDay:()=>e.povoleneCasyPodlaDna}},computed:{apiBase(){return(this.$store?.state?.api||"").replace(/\/+$/,"")+"/edupage/"},teacherId(){const e=[59,54,607,945,53],t=Number(this.$store?.state?.user?.id||0);return e.includes(t)?t:null},hasCalendar(){return this.dostupnost.length>0},selectedDateDMY(){return this.normalizeToDMY(this.selectedDateISO||"")},editRequest(){return this.$store.state.ui?.editRequest||null}},methods:{scheduleFlowReload(){this.flowReloadScheduled||(this.flowReloadScheduled=!0,queueMicrotask((()=>{this.flowReloadScheduled=!1,this.$refs.flow?.nacitajHodiny?.()})))},async safeFetch(e,t={},n=null){return n&&(this.acLoads[n]?.abort?.(),this.acLoads[n]=new AbortController,t.signal=this.acLoads[n].signal),fetch(e,t)},async parseMaybeJSON(e){const t=await e.text(),n=e.headers.get("content-type")||"";if(n.includes("application/json"))try{return JSON.parse(t)}catch{return null}try{return JSON.parse(t)}catch{return null}},toDMY(e){if(!(e instanceof Date))return"";const t=String(e.getDate()).padStart(2,"0"),n=String(e.getMonth()+1).padStart(2,"0"),s=e.getFullYear();return`${t}.${n}.${s}`},normalizeToDMY(e){if(!e)return"";if("string"===typeof e&&/^\d{2}\.\d{2}\.\d{4}$/.test(e))return e;if("string"===typeof e&&/^\d{4}-\d{2}-\d{2}$/.test(e)){const[t,n,s]=e.split("-").map((e=>parseInt(e,10)));return this.toDMY(new Date(t,n-1,s))}if(e instanceof Date)return this.toDMY(e);if("string"===typeof e){const t=Date.parse(e);if(!isNaN(t))return this.toDMY(new Date(t))}return""},async nacitajDostupnost(){if(!this.teacherId)return this.dostupnost=[],this.povoleneDni=[],this.povoleneCasyPodlaDna={},void(this.showFilter=!1);const e=await this.safeFetch(this.apiBase+"loadCalendarCustom.php?teacher_id="+this.teacherId,{credentials:"include"},"avail"),t=await this.parseMaybeJSON(e),n=Array.isArray(t?.data)?t.data:Array.isArray(t)?t:[],s=String(this.teacherId),o=[];for(const i of n){const e=String(i.teacher_id??i.teacherId??i.teacherID??"");if(e!==s)continue;let t=i?.data;if("string"===typeof t){const e=t.trim();if(e)try{t=JSON.parse(e)}catch{t=null}else t=null}t&&o.push({id:Number(i.id||0)||null,den:t.den||t.day||"",miesto:t.miesto||t.location||"",od:t.od||t.from||"",do:t.do||t.to||""})}this.dostupnost=o,this.povoleneDni=Array.from(new Set(o.map((e=>e.den)))).filter(Boolean);const a={};for(const i of this.povoleneDni)a[i]=[];for(const i of o)a[i.den]||(a[i.den]=[]),a[i.den].push(...this.slotyStvrtHod(i.od,i.do));if(Object.keys(a).forEach((e=>{a[e]=Array.from(new Set(a[e])).sort()})),this.povoleneCasyPodlaDna=a,!this.currentDay){const e=this.todayName();this.currentDay=this.povoleneDni.includes(e)?e:this.povoleneDni[0]||""}this.showFilter=this.hasCalendar&&this.povoleneDni.length>0,localStorage.setItem(I,JSON.stringify({dostupnost:this.dostupnost,povoleneDni:this.povoleneDni,povoleneCasyPodlaDna:this.povoleneCasyPodlaDna})),this.scheduleFlowReload()},async createLessonsNextWeek(){if(!this.createBusy){this.createBusy=!0,this.createErr="",this.createMsg="";try{const e=await this.safeFetch(this.apiBase+"createLesson.php",{method:"POST",credentials:"include"});let t=null;try{t=await this.parseMaybeJSON(e)}catch{t=null}const n=e.ok&&(!0===t||!0===t?.ok||!0===t?.success||"Request succesfull"===t?.status||/^(ok|true|1)$/i.test(String(t?.status||""))||/request\s+succes+full/i.test(String(t?.status||""))||null===t);if(!n)throw new Error(t?.message||t?.error||"Vytvorenie zlyhalo.");this.createMsg="Lekcie na nadchádzajúci týždeň boli vytvorené.",this.$store.state.SnackBarText=this.createMsg,this.scheduleFlowReload()}catch(e){this.createErr=e?.message||"Vytvorenie zlyhalo.",this.$store.state.SnackBarText=this.createErr}finally{this.createBusy=!1}}},slotyStvrtHod(e,t){if(!e||!t)return[];const n=e+">"+t,s=this.slotCache.get(n);if(s)return s;const[o,a]=String(e).split(":").map((e=>parseInt(e,10))),[i,r]=String(t).split(":").map((e=>parseInt(e,10)));if(![o,a,i,r].every(Number.isFinite))return[];const l=[];let d=60*o+a;const c=60*i+r;while(d<c){const e=String(Math.floor(d/60)).padStart(2,"0"),t=String(d%60).padStart(2,"0");l.push(`${e}:${t}`),d+=15}return this.slotCache.set(n,l),l},async fetchHoursCount(){if(!this.teacherId)return this.hasAnyHours=!1,void localStorage.setItem(b,"false");const e=new URLSearchParams;e.append("teacher_id",String(this.teacherId));const t=await this.safeFetch(this.apiBase+"loadCalendar.php?"+e,{credentials:"include"},"hours"),n=await this.parseMaybeJSON(t),s=Array.isArray(n?.data)?n.data:Array.isArray(n)?n:[];this.hasAnyHours=s.length>0,localStorage.setItem(b,JSON.stringify(this.hasAnyHours))},onDayChanged(e){e&&("string"===typeof e?this.currentDay=e:e instanceof Date?this.currentDay=this.dayNameSkFromDate(e):e.dayName&&(this.currentDay=e.dayName),localStorage.setItem(k,this.currentDay||""),this.scheduleFlowReload())},onDateChanged(e){"string"===typeof e&&/^\d{4}-\d{2}-\d{2}$/.test(e)&&(this.selectedDateISO=e,localStorage.setItem(x,e),this.scheduleFlowReload())},dayNameSkFromDate(e){const t=["Nedeľa","Pondelok","Utorok","Streda","Štvrtok","Piatok","Sobota"];return t[e.getDay()]},todayName(){return this.dayNameSkFromDate(new Date)},openModal(e={}){const{component:t,props:n}=e;this.modalComponent=t||D,this.modalProps={...n||{},availability:this.dostupnost,allowedDaysFull:this.povoleneDni,allowedTimesByDay:this.povoleneCasyPodlaDna,teacherId:this.teacherId,closeOnSave:!0},this.modalOpen=!0},async handleModalClose(){this.modalOpen=!1;const e=this.selectedDateISO,t=this.currentDay;await Promise.all([this.nacitajDostupnost(),this.fetchHoursCount(),this.fetchStudentsUnassignedCount()]),e&&(this.selectedDateISO=e,localStorage.setItem(x,e)),t&&(this.currentDay=t,localStorage.setItem(k,t)),this.showFilter=this.hasCalendar&&this.povoleneDni.length>0,this.scheduleFlowReload()},openSummaryModal(e){const t=this.selectedDateDMY;this.openModal({component:v,props:{summary:e,selectedDate:t}})},openAddCiselnyZapis(e){const t=this.selectedDateDMY;this.openModal({component:M,props:{summary:e,selectedDate:t}})},chooseInitialTime(e){const t=this.povoleneCasyPodlaDna?.[e]||[];if(!t.length)return"";const n=new Date,s=String(n.getHours()).padStart(2,"0")+":"+String(n.getMinutes()).padStart(2,"0"),o=e=>{const[t,n]=e.split(":").map((e=>parseInt(e,10)));return 60*t+n};let a=t[0],i=Math.abs(o(a)-o(s));for(const r of t){const e=Math.abs(o(r)-o(s));e<i&&(a=r,i=e)}return a},async fetchStudentsUnassignedCount(){try{const e=this.apiBase+"loadStudentsUnassigned.php"+(this.teacherId?`?teacher_id=${this.teacherId}`:""),t=await this.safeFetch(e,{credentials:"include"},"unplan"),n=await this.parseMaybeJSON(t),s=Array.isArray(n?.data)?n.data:Array.isArray(n)?n:[],o=s.filter((e=>e&&"null"!==e&&""!==e));this.studentsWithoutLessons=o.length,localStorage.setItem(O,String(this.studentsWithoutLessons))}catch{this.studentsWithoutLessons=0,localStorage.setItem(O,"0")}},onAddStudent(){this.closeContextMenu();const e=this.currentDay&&this.povoleneDni.includes(this.currentDay)?this.currentDay:this.povoleneDni.includes(this.todayName())?this.todayName():this.povoleneDni[0]||"",t=this.chooseInitialTime(e);this.openModal({component:S,props:{predvolenyDen:e,predvolenyCas:t}})},openContextMenu(e,t=null){t?(this.contextMenu.mode="lecture",this.contextMenu.target=t):(this.contextMenu.mode="section",this.contextMenu.target=null),this.contextMenu.error="",this.contextMenu.busy=!1,this.contextMenu.visible=!0,this.$nextTick((()=>{const t=this.$refs.ctxMenu;if(!t)return;const n=8,s=t.getBoundingClientRect(),o=window.innerWidth,a=window.innerHeight;let i=e.clientX,r=e.clientY;i+s.width+n>o&&(i=o-s.width-n),r+s.height+n>a&&(r=a-s.height-n),i<n&&(i=n),r<n&&(r=n),this.contextMenu.x=i,this.contextMenu.y=r}))},closeContextMenu(){this.contextMenu.visible&&(this.contextMenu.visible=!1)},onSectionContext(e){e.target.closest(".lecture")||e.target.closest(".context-menu")||this.openContextMenu(e,null)},async deleteSelected(){const e=this.contextMenu.target;if(e&&e.id){this.contextMenu.busy=!0,this.contextMenu.error="";try{const t=new URLSearchParams;t.append("id",String(e.id)),t.append("delete","true");const n=await this.safeFetch(this.apiBase+"editCalendar.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:t,credentials:"include"}),s=await this.parseMaybeJSON(n),o=n.ok&&("Request succesfull"===s?.status||!0===s?.ok||!0===s?.success||/^(ok|true|1)$/i.test(String(s?.status||"")));if(!o)throw new Error(s?.message||s?.error||"Mazanie zlyhalo.");this.closeContextMenu(),this.$store.state.SnackBarText="Hodina bola vymazaná.",this.scheduleFlowReload()}catch(t){this.contextMenu.error=t?.message||"Mazanie zlyhalo.",this.$store.state.SnackBarText=this.contextMenu.error}finally{this.contextMenu.busy=!1}}},onEditRequest(e){const t=e&&e.detail?e.detail:e||{},n=t.dayName||this.currentDay||"",s=t.hour||this.chooseInitialTime(n)||"";this.openModal({component:S,props:{edit:!0,calendarId:t.calendarId||null,studentId:t.studentId||null,duoStudentId:t.duoStudentId||null,studentName:t.studentName||"",formOfStudy:t.formOfStudy||"",predvolenyDen:n,predvolenyCas:s}}),this.openModal({component:C,props:{calendarId:t.calendarId,dayName:t.dayName,hour:t.hour,formOfStudy:t.formOfStudy,studentId:t.studentId,duoStudentId:t.duoStudentId}})}},async mounted(){if(!this.selectedDateISO){const e=(new Date).toISOString().slice(0,10);this.selectedDateISO=e,localStorage.setItem(x,e)}this.currentDay||(this.currentDay=this.todayName(),localStorage.setItem(k,this.currentDay)),this.showFilter=this.povoleneDni.length>0,this.teacherId?Promise.all([this.nacitajDostupnost(),this.fetchHoursCount(),this.fetchStudentsUnassignedCount()]).then((()=>{this.showFilter=this.hasCalendar&&this.povoleneDni.length>0,this.scheduleFlowReload()})):this.showFilter=!1,this._ctxKeyHandler=e=>{"Escape"===e.key&&this.closeContextMenu()},this._ctxOutsideHandler=e=>{const t=this.$refs.ctxMenu;this.contextMenu.visible&&t&&!t.contains(e.target)&&this.closeContextMenu()},this._ctxResizeHandler=()=>this.closeContextMenu(),this._editHandler=e=>this.onEditRequest(e),window.addEventListener("keydown",this._ctxKeyHandler),window.addEventListener("mousedown",this._ctxOutsideHandler,!0),window.addEventListener("scroll",this._ctxResizeHandler,!0),window.addEventListener("resize",this._ctxResizeHandler),window.addEventListener("ui:edit-request",this._editHandler)},watch:{"$store.state.user"(e,t){e?.id&&e?.id!==t?.id&&(this.nacitajDostupnost().then((()=>{this.showFilter=this.hasCalendar&&this.povoleneDni.length>0,this.scheduleFlowReload()})),this.fetchHoursCount(),this.fetchStudentsUnassignedCount())},editRequest(e){e&&(this.onEditRequest(e),this.$nextTick((()=>this.$store.commit("ui/CLEAR_EDIT"))))}},unmounted(){window.removeEventListener("keydown",this._ctxKeyHandler),window.removeEventListener("mousedown",this._ctxOutsideHandler,!0),window.removeEventListener("scroll",this._ctxResizeHandler,!0),window.removeEventListener("resize",this._ctxResizeHandler),window.removeEventListener("ui:edit-request",this._editHandler)}},F=n(89);const N=(0,F.Z)(R,[["render",y],["__scopeId","data-v-2e17a922"]]);var _=N},1682:function(e,t,n){e.exports=n.p+"img/settingEdupage.7629fdcc.svg"}}]);