"use strict";(self["webpackChunkheligonkova_akademia"]=self["webpackChunkheligonkova_akademia"]||[]).push([[8870],{8870:function(e,t,s){s.r(t),s.d(t,{default:function(){return v}});var i=s(3396),a=s(7139),n=s(9242);const r={class:"formular"},o={class:"chips"},l=["onDblclick","title"],c={class:"pesnicky-wrapper"},d=["onUpdate:modelValue","onChange"],h=["value"];function u(e,t,s,u,p,m){return(0,i.wg)(),(0,i.iD)("div",r,[t[2]||(t[2]=(0,i._)("h5",null,"Pridať číselný zápis",-1)),t[3]||(t[3]=(0,i._)("div",{class:"text"},"Vyber zápis:",-1)),(0,i._)("div",o,[((0,i.wg)(!0),(0,i.iD)(i.HY,null,(0,i.Ko)(p.selected,(e=>((0,i.wg)(),(0,i.iD)("span",{key:e?.id||e?.name||e,class:(0,a.C_)(["chip",{"chip--locked":!!e?.locked}]),onDblclick:(0,n.iM)((t=>m.onChipDblclick(e)),["prevent"]),title:e?.locked?"Priradené z poznámky – nemožno odstrániť":"Dvojklik odstráni"},(0,a.zw)(e?.name||e),43,l)))),128))]),(0,i._)("div",c,[((0,i.wg)(!0),(0,i.iD)(i.HY,null,(0,i.Ko)(p.selects,((e,s)=>((0,i.wg)(),(0,i.iD)("div",{class:"pesnicka",key:s},[(0,i.wy)((0,i._)("select",{"onUpdate:modelValue":e=>p.selects[s]=e,onChange:e=>m.onSelectChange(s)},[t[1]||(t[1]=(0,i._)("option",{disabled:"",value:""},"Vyber zápis…",-1)),((0,i.wg)(!0),(0,i.iD)(i.HY,null,(0,i.Ko)(m.optionsFor(s),(e=>((0,i.wg)(),(0,i.iD)("option",{key:e.id,value:e},(0,a.zw)(e.name)+" - "+(0,a.zw)(e.id)+" ("+(0,a.zw)(e.price)+"€) ",9,h)))),128))],40,d),[[n.bM,p.selects[s]]])])))),128))]),(0,i._)("div",{class:"button Adumu",onClick:t[0]||(t[0]=(...e)=>m.pridatVybrane&&m.pridatVybrane(...e))},"Pridať")])}s(560),s(8858),s(1318),s(3228);var p={data(){return{allSongs:[],selected:[],selects:[null]}},props:{summary:{type:Object,default:()=>({id:null,students:[],lessonId:null})},activeStudentId:{type:[String,Number],default:null},activeStudentIndex:{type:Number,default:0},selectedDate:{type:String,default:""}},computed:{effectiveDate(){return this.selectedDate||this.summary.date||this.lessonMeta.date||""},activeUserIds(){const e=Array.isArray(this.summary?.students)?this.summary.students:[],t=e.map((e=>e&&null!=e.id?String(e.id):null)).filter((e=>e)),s=null!==this.activeStudentId&&void 0!==this.activeStudentId&&""!==this.activeStudentId?[String(this.activeStudentId)]:[],i=Array.from(new Set([...t,...s]));return i}},mounted(){this.activeUserIds.length&&this.nacitajNevlastneneZapisyPreUzivatelov(this.activeUserIds),this.loadAssignedFromNote()},watch:{summary:{handler(){this.activeUserIds.length&&(this.nacitajNevlastneneZapisyPreUzivatelov(this.activeUserIds),this.loadAssignedFromNote())},deep:!0},activeStudentId(){this.activeUserIds.length&&(this.nacitajNevlastneneZapisyPreUzivatelov(this.activeUserIds),this.loadAssignedFromNote())},activeStudentIndex(){this.activeUserIds.length&&(this.nacitajNevlastneneZapisyPreUzivatelov(this.activeUserIds),this.loadAssignedFromNote())}},methods:{onChipDblclick(e){e&&e.locked||this.removeSong(e)},async loadAssignedFromNote(){try{const e=this.summary?.id;if(!e)return;const t=`${this.$store.state.api}/edupage/loadLesson.php?calendar_id=${encodeURIComponent(e)}`,s=this.effectiveDate?`${t}&date=${encodeURIComponent(this.effectiveDate)}`:t,i=await fetch(s,{credentials:"include"}),a=await i.json().catch((()=>({}))),n=Array.isArray(a?.data)?a.data:[];if(n.length,!n.length)return;const r=n.reduce(((e,t)=>!e||+t.id>+e.id?t:e),null);if(!r)return;let o=[];try{o=JSON.parse(r.student||"[]")}catch{o=[]}o.length;const l=new Set((Array.isArray(this.summary?.students)?this.summary.students:[]).map((e=>String(e.id)))),c=/(Pridané\s+noty\s+s\s+id|Add\s+notes\s+id)\s*[:=]\s*(\d+)/gi,d=new Set;for(const p of o){const e=p?.student_id??p?.id;if(!e||!l.has(String(e)))continue;const t=String(p?.note||"");let s;while(null!==(s=c.exec(t))){const e=parseInt(s[2],10);Number.isNaN(e)||d.add(e)}}if(d.size,!d.size)return;const h=await Promise.all(Array.from(d).map((async e=>{const t=await this.nacitajNazovProduktu(e);return{id:e,name:t.name||`Zápis #${e}`,price:"number"===typeof t.price?t.price:t.price?Number(t.price):null}}))),u=new Set(this.selected.map((e=>e&&e.id)));for(const p of h)u.has(p.id)||this.selected.push({id:p.id,name:p.name,price:p.price??null,locked:!0});"function"===typeof this.normalizeSelects&&this.normalizeSelects()}catch(e){}},async nacitajNevlastneneZapisyPreUzivatelov(e){this.pouzivatelNevlastenene=[];try{const t=await Promise.all(e.map((e=>this.getNotOwnedIdsFor(e)))),s=Array.from(new Set(t.flat()));this.pouzivatelNevlastenene=s.map((e=>({id:e,name:"",price:null}))),await Promise.all(this.pouzivatelNevlastenene.map((async e=>{const t=await this.nacitajNazovProduktu(e.id);e.name=t.name||"",e.price="number"===typeof t.price?t.price:t.price?Number(t.price):null}))),this.pouzivatelNevlastenene.sort(((e,t)=>e.name.toLowerCase().localeCompare(t.name.toLowerCase()))),this.allSongs=this.pouzivatelNevlastenene,"function"===typeof this.normalizeSelects&&this.normalizeSelects()}catch(t){}},async getNotOwnedIdsFor(e){const t=s(7218),i=s(6237);let a=new i;const n={method:"get",maxBodyLength:1/0,url:this.$store.state.api+"/user/stats/getZapisNotOwned.php?user_id="+encodeURIComponent(e),data:a};try{const e=await t.request(n),s=Array.isArray(e?.data?.data)?e.data.data:[];return s.map((e=>parseInt(e,10))).filter((e=>!isNaN(e)))}catch(r){return[]}},async nacitajNazovProduktu(e){const t=s(7218),i={method:"get",maxBodyLength:1/0,url:this.$store.state.api+"/product/loadLimited.php/?id="+e,headers:{}};try{const e=await t.request(i),s=e?.data?.data||{},a=s.name||"",n=void 0!==s.price?s.price:s.cena,r=void 0!==n&&null!==n&&""!==n?Number(n):null;return{name:a,price:r}}catch(a){return{name:"",price:null}}},optionsFor(e){const t=this.selects[e],s=new Set(this.selected.map((e=>e&&e.id))),i=this.allSongs.filter((e=>!s.has(e.id))).sort(((e,t)=>e.name.toLowerCase().localeCompare(t.name.toLowerCase())));return t&&!i.some((e=>e.id===t.id))?[t,...i]:i},onSelectChange(e){const t=this.selects[e];if(!t||"object"!==typeof t)return;const s=this.selected.some((e=>e.id===t.id));s||this.selected.push({id:t.id,name:t.name,price:t.price}),this.normalizeSelects()},removeSong(e){const t=e&&e.id?e.id:null;null!==t&&(this.selected=this.selected.filter((e=>e.id!==t)),this.selects=this.selects.map((e=>e&&e.id===t?null:e)),this.normalizeSelects())},normalizeSelects(){const e=this.selects.filter((e=>e&&"object"===typeof e)),t=new Set(this.selected.map((e=>e.id))),s=this.allSongs.filter((e=>!t.has(e.id))).length;this.selects=[...e,null],0===s&&(this.selects=[null])},async fetchSongs(){try{const e=await fetch("https://heligonkovaakademia.sk/api/zapisy/list.php");if(!e.ok)throw new Error("Network response was not ok");const t=await e.json();Array.isArray(t)?this.allSongs=t.map((e=>({id:e.id,name:e.name,price:void 0!==e.price?Number(e.price):void 0!==e.cena?Number(e.cena):null}))):Array.isArray(t.songs)&&(this.allSongs=t.songs.map((e=>({id:e.id,name:e.name,price:void 0!==e.price?Number(e.price):void 0!==e.cena?Number(e.cena):null})))),"function"===typeof this.normalizeSelects&&this.normalizeSelects()}catch(e){}},async submit(){try{const e=await fetch("https://heligonkovaakademia.sk/api/zapisy/add.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({songs:this.selected})});await e.json()}catch(e){}},async pridatVybrane(){try{const e=Array.isArray(this.activeUserIds)?this.activeUserIds:[];if(!e.length)return;const t=Array.isArray(this.selected)?this.selected.filter((e=>e&&"object"===typeof e&&null!=e.id&&!e.locked)):[];if(!t.length)return;const s=t.map((e=>e.id)),i=Array.from(new Set(s)),a=Array.from(new Set(e)),n=this.summary&&void 0!==this.summary.lessonId?this.summary.lessonId:null,r=this.$store.state.api+"/edupage/addToOwnedAtLesson.php",o=(e,t)=>{const s=new URLSearchParams({user_id:String(e),product_id:String(t)});return null!==n&&void 0!==n&&""!==String(n)&&s.append("lesson_id",String(n)),`${r}?${s.toString()}`},l=[];for(const p of a)for(const e of i)l.push(fetch(o(p,e),{credentials:"include"}).then((e=>e.json())).then((t=>({uid:p,pid:e,ok:"Request succesfull"===t?.status,resp:t}))).catch((t=>({uid:p,pid:e,ok:!1,error:String(t)}))));const c=await Promise.allSettled(l),d=c.map((e=>"fulfilled"===e.status?e.value:e.reason)),h=d.filter((e=>e&&e.ok)).length,u=d.length-h;this.$store.state.SnackBarText=0===u?"✅ Zápisy boli úspešne priradené všetkým zvoleným žiakom.":h>0?`⚠️ Čiastočný úspech: ${h} OK, ${u} zlyhalo. Skontroluj konzolu.`:"❌ Nepodarilo sa pridať žiadny zápis. Skontroluj prihlásenie/roly alebo API."}catch(e){this.$store.state.SnackBarText="❌ Nastala neočakávaná chyba pri odosielaní požiadaviek."}}}},m=s(89);const y=(0,m.Z)(p,[["render",u],["__scopeId","data-v-75701670"]]);var v=y}}]);