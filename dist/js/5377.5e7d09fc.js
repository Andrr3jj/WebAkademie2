"use strict";(self["webpackChunkheligonkova_akademia"]=self["webpackChunkheligonkova_akademia"]||[]).push([[5377],{5377:function(e,t,a){a.r(t),a.d(t,{default:function(){return I}});var r=a(3396),n=a(9242),i=a(7139);const s={class:"formular"},d={class:"rozvrh"},o=["onUpdate:modelValue"],l={class:"day"},c=["disabled","onUpdate:modelValue"],h=["value"],u=["disabled","onUpdate:modelValue"],p=["value"],m=["disabled","onUpdate:modelValue"],y=["value"],S=["disabled"];function w(e,t,a,w,f,b){return(0,r.wg)(),(0,r.iD)("div",s,[t[3]||(t[3]=(0,r._)("h5",null,"Naplánuj si svoje výučbové dni",-1)),t[4]||(t[4]=(0,r._)("p",{class:"text"}," Označ, v ktoré dni budeš učiť, kde budeš učiť a v akom čase. ",-1)),(0,r._)("div",d,[((0,r.wg)(!0),(0,r.iD)(r.HY,null,(0,r.Ko)(f.days,((e,a)=>((0,r.wg)(),(0,r.iD)("div",{class:"den",key:a},[(0,r.wy)((0,r._)("input",{type:"checkbox","onUpdate:modelValue":t=>e.enabled=t},null,8,o),[[n.e8,e.enabled]]),(0,r._)("p",l,(0,i.zw)(e.name),1),(0,r.wy)((0,r._)("select",{disabled:!e.enabled,"onUpdate:modelValue":t=>e.location=t},[((0,r.wg)(!0),(0,r.iD)(r.HY,null,(0,r.Ko)(f.locations,(e=>((0,r.wg)(),(0,r.iD)("option",{key:e,value:e},(0,i.zw)(e),9,h)))),128))],8,c),[[n.bM,e.location]]),(0,r.wy)((0,r._)("select",{disabled:!e.enabled,"onUpdate:modelValue":t=>e.start=t},[t[1]||(t[1]=(0,r._)("option",{value:"",disabled:""},"Od:",-1)),((0,r.wg)(!0),(0,r.iD)(r.HY,null,(0,r.Ko)(b.allTimes,(e=>((0,r.wg)(),(0,r.iD)("option",{key:e,value:e},(0,i.zw)(e),9,p)))),128))],8,u),[[n.bM,e.start]]),(0,r.wy)((0,r._)("select",{disabled:!e.start,"onUpdate:modelValue":t=>e.end=t},[t[2]||(t[2]=(0,r._)("option",{value:"",disabled:""},"Do:",-1)),((0,r.wg)(!0),(0,r.iD)(r.HY,null,(0,r.Ko)(b.endOptions(e),(e=>((0,r.wg)(),(0,r.iD)("option",{key:e,value:e},(0,i.zw)(e),9,y)))),128))],8,m),[[n.bM,e.end]])])))),128))]),t[5]||(t[5]=(0,r._)("p",{class:"text smaller"}," Tvoj rozvrh ovplyvňuje, či ťa môžu noví žiaci kontaktovať. ",-1)),t[6]||(t[6]=(0,r._)("p",{class:"text small"}," Na základe tebou nastavených výučbových dní, miest a časov bude systém vedieť, kedy si dostupný. ",-1)),(0,r._)("button",{class:(0,i.C_)(["button",{disabled:!b.canSave}]),disabled:!b.canSave,onClick:t[0]||(t[0]=(...e)=>b.saveDays&&b.saveDays(...e))},(0,i.zw)(f.loading?"Ukladám...":"Uložiť"),11,S)])}a(560),a(8858),a(1318),a(3228);var f={name:"CasyUcenia",props:{closeOnSave:{type:Boolean,default:!0}},data(){return{loading:!1,message:"",error:"",lastSavedSig:null,days:[{name:"Pondelok",enabled:!1,location:"Kamenná Poruba",start:"",end:"",primaryId:null,primarySnapshot:null,extraIds:[],extraSnapshots:{}},{name:"Utorok",enabled:!1,location:"Kamenná Poruba",start:"",end:"",primaryId:null,primarySnapshot:null,extraIds:[],extraSnapshots:{}},{name:"Streda",enabled:!1,location:"Kamenná Poruba",start:"",end:"",primaryId:null,primarySnapshot:null,extraIds:[],extraSnapshots:{}},{name:"Štvrtok",enabled:!1,location:"Kamenná Poruba",start:"",end:"",primaryId:null,primarySnapshot:null,extraIds:[],extraSnapshots:{}},{name:"Piatok",enabled:!1,location:"Kamenná Poruba",start:"",end:"",primaryId:null,primarySnapshot:null,extraIds:[],extraSnapshots:{}}],locations:["Hlboké nad Váhom","Kamenná Poruba","Lietavská Svinná","Zákamenné","Krasňany","Skalité","Rajec","Varín","Nededza","Belá"]}},computed:{allTimes(){const e=[];for(let t=0;t<24;t++)for(let a=0;a<60;a+=15)e.push(`${String(t).padStart(2,"0")}:${String(a).padStart(2,"0")}`);return e},apiBase(){return(this.$store?.state?.api||"").replace(/\/+$/,"")+"/edupage/"},teacherId(){const e=Number(this.$store?.state?.user?.id);if(Number.isFinite(e)&&e>0)return Math.trunc(e);const t=Number(new URLSearchParams(location.search).get("teacher_id"));return Number.isFinite(t)&&t>0?Math.trunc(t):null},sigData(){return this.days.map((e=>({name:e.name,enabled:!!e.enabled,location:e.location||"",start:e.start||"",end:e.end||""})))},currentSig(){return JSON.stringify(this.sigData)},hasChanges(){return this.currentSig!==this.lastSavedSig},canSave(){return!!this.teacherId&&!this.loading&&this.hasChanges}},methods:{endOptions(e){if(!e.start)return[];const t=this.allTimes.indexOf(e.start);return-1===t?[]:this.allTimes.slice(t+1)},makeDataObj(e){return{den:e.name,miesto:e.location||"",od:e.start||"",do:e.end||""}},sameData(e,t){return JSON.stringify(e)===JSON.stringify(t)},looseField(e,t){for(const a of t){let t=e.match(new RegExp(`"(?:${a})"\\s*:\\s*"([^"]*)"`,"i"));if(t&&null!=t[1])return t[1];if(t=e.match(new RegExp(`'(?:${a})'\\s*:\\s*'([^']*)'`,"i")),t&&null!=t[1])return t[1];if(t=e.match(new RegExp(`\\b(?:${a})\\b\\s*:\\s*"([^"]*)"`,"i")),t&&null!=t[1])return t[1];if(t=e.match(new RegExp(`\\b(?:${a})\\b\\s*:\\s*'([^']*)'`,"i")),t&&null!=t[1])return t[1]}return""},rowToSnapshot(e){let t=e.data??e.DATA??"{}";for(let r=0;r<2&&"string"===typeof t;r++)try{t=JSON.parse(t)}catch{break}if(t&&"object"===typeof t)return{den:(t.den||t.day||"").toString().trim(),miesto:(t.miesto||t.location||"").toString().trim(),od:(t.od||t.start||"").toString().trim(),do:(t.do||t.end||"").toString().trim()};const a=String(e.data||e.DATA||"");return{den:this.looseField(a,["den","day"]).trim(),miesto:this.looseField(a,["miesto","location"]).trim(),od:this.looseField(a,["od","start"]).trim(),do:this.looseField(a,["do","end"]).trim()}},async fetchCalendarRows(){const e=new URLSearchParams;Number.isFinite(this.teacherId)&&this.teacherId>0&&e.set("teacher_id",String(this.teacherId));const t=this.apiBase+"loadCalendarCustom.php"+(e.toString()?"?"+e.toString():""),a=await fetch(t,{credentials:"include"}),r=await a.text();let n;try{n=JSON.parse(r)}catch{n=null}return Array.isArray(n?.data)?n.data:Array.isArray(n)?n:[]},applyAvailabilityRows(e){for(const t of e){const e=Number(t.id||t.ID||t.Id||0)||null,a=this.rowToSnapshot(t),r=a.den||"",n=this.days.find((e=>e.name.toLowerCase()===r.toLowerCase()));n&&e&&(null==n.primaryId?(n.primaryId=e,n.primarySnapshot=a,n.enabled=!0,n.location=a.miesto,n.start=a.od,n.end=a.do):(n.extraIds.includes(e)||n.extraIds.push(e),n.extraSnapshots[e]=a))}},setSavedSignature(){this.lastSavedSig=this.currentSig},extractId(e){return e?.id||e?.data?.id||e?.inserted_id||e?.new_id||e?.DATA?.id||null},dayIdIndex(e){const t={};for(const a of e){const e=Number(a.id||a.ID||a.Id||0)||null;if(!e)continue;const r=this.rowToSnapshot(a),n=(r.den||"").toLowerCase();n&&((!t[n]||e>t[n])&&(t[n]=e))}return t},findExactId(e,t){const a={den:(t.den||"").trim(),miesto:(t.miesto||"").trim(),od:(t.od||"").trim(),do:(t.do||"").trim()};for(const r of e){const e=Number(r.id||r.ID||r.Id||0)||null;if(!e)continue;const t=this.rowToSnapshot(r);if((t.den||"").trim()===a.den&&(t.miesto||"").trim()===a.miesto&&(t.od||"").trim()===a.od&&(t.do||"").trim()===a.do)return e}return null},async createCalendarEntry(e){const t=new URLSearchParams,a=Number.isFinite(this.teacherId)?Math.trunc(this.teacherId):0;t.append("teacher_id",String(a)),t.append("data",JSON.stringify(e));const r=await fetch(`${this.apiBase}editCalendarCustom.php`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:t,credentials:"include"}),n=await r.text();let i;try{i=JSON.parse(n)}catch{i={ok:r.ok,raw:n}}if(!r.ok||i?.error||"Request failed"===i?.status)throw new Error(i?.message||i?.error||`HTTP ${r.status}`);let s=i?.id||i?.data?.id||i?.inserted_id||i?.new_id||null;if(!s){const t=await this.fetchCalendarRows();s=this.findExactId(t,e)||this.dayIdIndex(t)[(e.den||"").toLowerCase()]||null}return{id:s}},async updateCalendarEntry(e,t){const a=Number.isFinite(this.teacherId)?Math.trunc(this.teacherId):0,r=`${this.apiBase}editCalendarCustom.php?id=${encodeURIComponent(String(e))}`,n=new URLSearchParams;n.append("id",String(e)),n.append("teacher_id",String(a)),n.append("data",JSON.stringify(t));const i=await fetch(r,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:n,credentials:"include"}),s=await i.text();let d;try{d=JSON.parse(s)}catch{d={ok:i.ok,raw:s}}if(!i.ok||d?.error||"Request failed"===d?.status)throw new Error(d?.message||d?.error||`HTTP ${i.status}`);return d},async deleteCalendarEntry(e){const t=Number.isFinite(this.teacherId)?Math.trunc(this.teacherId):0,a=`${this.apiBase}editCalendarCustom.php?id=${encodeURIComponent(String(e))}`,r=new URLSearchParams;r.append("id",String(e)),r.append("teacher_id",String(t)),r.append("delete","true");const n=await fetch(a,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:r,credentials:"include"}),i=await n.text();let s;try{s=JSON.parse(i)}catch{s={ok:n.ok,raw:i}}if(!n.ok||s?.error||"Request failed"===s?.status)throw new Error(s?.message||s?.error||`HTTP ${n.status}`);return s},async saveDays(){if(this.error="",!this.teacherId)return void(this.error="Nemáš oprávnenie ukladať rozvrh.");const e=this.days.find((e=>e.enabled&&!e.start));if(e)this.error=`Nastav čas Od pre deň ${e.name}.`;else{this.loading=!0;try{const e=await this.fetchCalendarRows(),t=this.dayIdIndex(e),a=[];for(const n of this.days){const e=this.makeDataObj(n);if(n.enabled)if(null==n.primaryId&&t[n.name.toLowerCase()]&&(n.primaryId=t[n.name.toLowerCase()]),null==n.primaryId)a.push(this.createCalendarEntry(e).then((e=>({type:"createPrimary",res:e,day:n}))));else{const t=n.primarySnapshot;t&&this.sameData(t,e)||a.push(this.updateCalendarEntry(n.primaryId,e).then((()=>({type:"updatePrimary",id:n.primaryId,day:n}))))}else{null!=n.primaryId&&a.push(this.deleteCalendarEntry(n.primaryId).then((()=>({type:"delPrimary",id:n.primaryId,day:n}))));for(const e of n.extraIds)a.push(this.deleteCalendarEntry(e).then((()=>({type:"delExtra",id:e,day:n}))))}}const r=await Promise.allSettled(a);for(const n of r){if("fulfilled"!==n.status)continue;const{type:e,res:t,id:a,day:r}=n.value;if("createPrimary"===e){let e=t?.id||t?.data?.id||t?.inserted_id||t?.new_id;if(!e){const t=await this.fetchCalendarRows();e=this.findExactId(t,this.makeDataObj(r))||this.dayIdIndex(t)[r.name.toLowerCase()]||null}e&&(r.primaryId=e,r.primarySnapshot={...this.makeDataObj(r)})}else"updatePrimary"===e?r.primarySnapshot={...this.makeDataObj(r)}:"delPrimary"===e?(r.primaryId=null,r.primarySnapshot=null):"delExtra"===e&&(r.extraIds=r.extraIds.filter((e=>e!==a)),delete r.extraSnapshots[a])}this.setSavedSignature(),this.closeOnSave&&this.$emit("close")}catch(t){this.error=t?.message||"Ukladanie zlyhalo."}finally{this.loading=!1}}}},watch:{teacherId:{immediate:!0,async handler(e){if(Number.isFinite(e)&&e>0){this.days.forEach((e=>{e.primaryId=null,e.primarySnapshot=null,e.enabled=!1,e.start="",e.end=""}));const e=await this.fetchCalendarRows();this.applyAvailabilityRows(e),this.setSavedSignature()}}}},async mounted(){await this.loadDays(),this.setSavedSignature()}},b=a(89);const g=(0,b.Z)(f,[["render",w],["__scopeId","data-v-28ce2fbc"]]);var I=g}}]);